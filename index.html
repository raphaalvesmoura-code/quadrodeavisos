<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Quadro de Avisos Â· Services4IT</title>
  <meta name="theme-color" content="#111827">
  <style>
    :root { --bg:#0f1115; --card:#171923; --muted:#9aa4b2; --text:#e7ecf3; --primary:#5b8cff; --good:#16a34a; --bad:#ef4444; }
    *{box-sizing:border-box} body{margin:0;background:#0b0f16;color:var(--text);font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    .container{max-width:900px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;background:#0b0f16cc;border-bottom:1px solid #1f2430;backdrop-filter:blur(8px);z-index:10}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .card{background:#141a24;border:1px solid #1f2734;border-radius:14px;overflow:hidden;margin-top:14px}
    .card .content{padding:14px}
    input,textarea,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a3142;background:#0f1520;color:#e7ecf3}
    .btn{border:1px solid #2a3142;background:#1a2030;color:#e7ecf3;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.good{background:var(--good);border-color:var(--good)}
    .btn.bad{background:var(--bad);border-color:var(--bad)}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:12px} @media(min-width:760px){.grid-2{grid-template-columns:1fr 1fr} .grid-3{grid-template-columns:repeat(3,1fr)}}
    .pill{border:1px solid #2b3350;border-radius:999px;padding:2px 8px;font-size:12px;color:#b9c4d3;display:inline-flex;align-items:center;gap:6px}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <header>
    <div class="container row" style="justify-content:space-between;padding:12px 0">
      <div class="row"><div style="width:36px;height:36px;border-radius:12px;background:#19233a;border:1px solid #243050;display:grid;place-items:center">ðŸ“£</div>
        <div style="margin-left:8px">
          <div style="font-weight:700">Quadro de Avisos Â· Realtime</div>
          <div class="muted" style="font-size:12px;line-height:1">Atualiza para todos em tempo real</div>
        </div>
      </div>
      <div class="row" id="authBar">
        <span id="whoami" class="muted" style="font-size:12px"></span>
        <button id="btnLogout" class="btn" style="display:none">Sair</button>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Login -->
    <div id="loginCard" class="card">
      <div class="content grid grid-2">
        <div>
          <label class="muted" style="font-size:12px">Eâ€‘mail (para publicar)</label>
          <input id="loginEmail" placeholder="seuemail@empresa.com">
        </div>
        <div>
          <label class="muted" style="font-size:12px">Senha</label>
          <input id="loginPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
        <div class="row" style="justify-content:flex-end;grid-column:1/-1;gap:8px">
          <button id="btnLogin" class="btn good">Entrar para Publicar</button>
        </div>
        <div class="muted" style="font-size:12px;grid-column:1/-1">
          Qualquer pessoa pode <b>ver</b> os avisos; apenas logados podem <b>publicar</b>.
        </div>
      </div>
    </div>

    <!-- Novo aviso -->
    <div id="formCard" class="card" style="display:none">
      <div class="content grid">
        <div class="grid grid-2">
          <div>
            <label class="muted" style="font-size:12px">TÃ­tulo</label>
            <input id="fTitle" placeholder="Ex.: Comunicado importante">
          </div>
          <div>
            <label class="muted" style="font-size:12px">Categoria</label>
            <select id="fCat">
              <option value="Geral">Geral</option>
              <option value="OperaÃ§Ã£o">OperaÃ§Ã£o</option>
              <option value="RH">RH</option>
              <option value="TI">TI</option>
              <option value="Eventos">Eventos</option>
              <option value="Comunicados">Comunicados</option>
            </select>
          </div>
        </div>
        <div>
          <label class="muted" style="font-size:12px">ConteÃºdo</label>
          <textarea id="fContent" rows="5" placeholder="Escreva o recado aquiâ€¦"></textarea>
        </div>
        <div class="row" style="justify-content:flex-end;gap:8px">
          <label class="row muted" style="gap:6px;font-size:12px"><input type="checkbox" id="fPinned"> Fixar no topo</label>
          <button id="btnPublish" class="btn primary">Publicar aviso</button>
        </div>
      </div>
    </div>

    <!-- Lista -->
    <div id="list"></div>
    <div id="empty" class="muted" style="text-align:center;padding:24px;display:none">Nenhum aviso por aquiâ€¦</div>

    <footer class="muted" style="text-align:center;padding:24px 0;font-size:12px;border-top:1px solid #1f2430">
      Quadro de Avisos Â· Firebase . Leitura pÃºblica; escrita com login.
    </footer>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {"apiKey": "AIzaSyC9QY7VVGdJC3Nk_n75n-Elp6tCu3Zme98", "authDomain": "quadro-avisos.firebaseapp.com", "projectId": "quadro-avisos", "storageBucket": "quadro-avisos.firebasestorage.app", "messagingSenderId": "1099271343859", "appId": "1:1099271343859:web:9644d41e5216679105f186"};
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const list = document.getElementById('list');
    const empty = document.getElementById('empty');
    const loginCard = document.getElementById('loginCard');
    const formCard = document.getElementById('formCard');
    const whoami = document.getElementById('whoami');
    const btnLogout = document.getElementById('btnLogout');

    document.getElementById('btnLogin').onclick = async () => {
      const email = document.getElementById('loginEmail').value.trim();
      const pass = document.getElementById('loginPass').value;
      if (!email || !pass) return alert('Informe eâ€‘mail e senha.');
      try { await signInWithEmailAndPassword(auth, email, pass); }
      catch (e) { console.error(e); alert('Falha no login. Ative "E-mail/senha" no Auth e crie o usuÃ¡rio.'); }
    };
    btnLogout.onclick = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
      if (user) {
        whoami.textContent = `Logado como: ${user.email}`;
        btnLogout.style.display = 'inline-block';
        loginCard.style.display = 'none';
        formCard.style.display = 'block';
      } else {
        whoami.textContent = '';
        btnLogout.style.display = 'none';
        loginCard.style.display = 'block';
        formCard.style.display = 'none';
      }
    });

    // Publicar
    document.getElementById('btnPublish').onclick = async () => {
      const title = document.getElementById('fTitle').value.trim();
      const content = document.getElementById('fContent').value.trim();
      const cat = document.getElementById('fCat').value;
      const pinned = document.getElementById('fPinned').checked;
      if (!title || !content) return alert('Preencha tÃ­tulo e conteÃºdo.');
      try {
        await addDoc(collection(db, 'avisos'), {
          title, content, category: cat, pinned: !!pinned, archived: false,
          author: (auth.currentUser?.email || 'Admin'),
          createdAt: serverTimestamp()
        });
        document.getElementById('fTitle').value = '';
        document.getElementById('fContent').value = '';
        document.getElementById('fPinned').checked = false;
      } catch(e) { console.error(e); alert('Erro ao publicar. Regras do Firestore?'); }
    };

    // HOTFIX: ordenar por data (apenas 1 orderBy) e ordenar fixados no cliente
    const q = query(collection(db, 'avisos'), orderBy('createdAt', 'desc'));

    onSnapshot(q, (snap) => {
      list.innerHTML = '';
      if (snap.empty) { empty.style.display = 'block'; return; } else empty.style.display = 'none';

      const itens = [];
      snap.forEach((docu) => { itens.push({ id: docu.id, ...docu.data() }); });

      itens.sort((A, B) => {
        const p = (B.pinned ? 1 : 0) - (A.pinned ? 1 : 0);
        if (p !== 0) return p;
        const ta = A.createdAt?.toMillis?.() ? A.createdAt.toMillis() : 0;
        const tb = B.createdAt?.toMillis?.() ? B.createdAt.toMillis() : 0;
        return tb - ta;
      });

      itens.forEach((a) => {
        const card = document.createElement('div'); card.className = 'card';
        const c = document.createElement('div'); c.className = 'content'; card.appendChild(c);

        const top = document.createElement('div'); top.className = 'row'; c.appendChild(top);
        const h = document.createElement('div');
        const ttl = document.createElement('div'); ttl.style.fontWeight='700'; ttl.textContent = a.title; h.appendChild(ttl);
        const meta = document.createElement('div'); meta.className='muted'; meta.style.fontSize='12px'; meta.textContent = `${a.category || 'â€”'} Â· ${a.author || 'â€”'}`; h.appendChild(meta);
        top.appendChild(h);

        const k = document.createElement('div'); k.className='row right';
        const btPin = document.createElement('button'); btPin.className='btn'; btPin.textContent = a.pinned ? 'Desafixar' : 'Fixar';
        btPin.onclick = async () => { try { await updateDoc(doc(db,'avisos', a.id), { pinned: !a.pinned }); } catch(e){ alert('Sem permissÃ£o. FaÃ§a login.'); } };
        const btDel = document.createElement('button'); btDel.className='btn bad'; btDel.textContent='Remover';
        btDel.onclick = async () => { if(confirm('Remover aviso?')) try { await deleteDoc(doc(db,'avisos', a.id)); } catch(e){ alert('Sem permissÃ£o. FaÃ§a login.'); } };
        k.append(btPin, btDel); top.appendChild(k);

        const body = document.createElement('div'); body.style.whiteSpace='pre-wrap'; body.style.lineHeight='1.5'; body.textContent = a.content; c.appendChild(body);
        const tags = document.createElement('div'); tags.style.marginTop='6px';
        if (a.pinned) { const p = document.createElement('span'); p.className='pill'; p.textContent='ðŸ“Œ Fixado'; tags.appendChild(p); }
        c.appendChild(tags);
        list.appendChild(card);
      });
    });
  </script>
</body>
</html>
